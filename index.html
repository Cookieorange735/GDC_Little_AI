<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI 虛擬圍籬監控系統</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.11.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.2/dist/coco-ssd.min.js"></script>

    <style>
        /* --- Professional UI Design (Dark/Cyberpunk Style) --- */
        :root {
            --primary-color: #00ffcc;
            --danger-color: #ff3333;
            --bg-color: #0d1117;
            --panel-bg: rgba(13, 17, 23, 0.85);
        }

        body {
            margin: 0;
            background-color: var(--bg-color);
            font-family: "Consolas", "Monaco", "Courier New", monospace; /* 使用等寬字體更像終端機 */
            color: white;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        #main-view {
            position: relative;
            flex: 1; /* 佔據上方大部分空間 */
            display: flex;
            justify-content: center;
            align-items: center;
            background: #000;
            border-bottom: 2px solid #333;
        }

        video, canvas {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* 儀表板區域 */
        #dashboard {
            height: 35%; /* 下方 35% 為資訊區 */
            background: var(--panel-bg);
            padding: 10px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            border-top: 1px solid var(--primary-color);
            z-index: 10;
        }

        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
        }

        h2 { margin: 0; font-size: 16px; color: var(--primary-color); text-transform: uppercase; letter-spacing: 1px; }

        #system-status {
            font-weight: bold;
            padding: 2px 8px;
            border-radius: 4px;
            background: #333;
            font-size: 14px;
        }
        
        .status-normal { color: #00ffcc; border: 1px solid #00ffcc; }
        .status-alert { color: #fff; background: var(--danger-color) !important; animation: blink 1s infinite; }

        /* 日誌列表 */
        #log-container {
            flex: 1;
            overflow-y: auto; /* 允許垂直捲動 */
            font-size: 12px;
            border: 1px solid #333;
            background: #000;
            padding: 5px;
        }

        .log-entry {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px solid #222;
        }
        .log-time { color: #888; margin-right: 10px; }
        .log-msg { color: #ddd; }
        .log-type-alert { color: var(--danger-color); }

        /* 載入畫面 */
        #loader-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 99;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        button {
            background: transparent;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            padding: 10px 30px;
            font-family: inherit;
            cursor: pointer;
            font-size: 16px;
            margin-top: 20px;
        }
        button:hover { background: rgba(0, 255, 204, 0.1); }

        @keyframes blink { 50% { opacity: 0.5; } }
    </style>
</head>
<body>

    <div id="main-view">
        <video id="video" playsinline muted autoplay></video>
        <canvas id="canvas"></canvas>
    </div>

    <div id="dashboard">
        <div class="header-row">
            <h2>SYSTEM LOG // 監控日誌</h2>
            <div id="system-status" class="status-normal">NORMAL</div>
        </div>
        <div id="log-container">
            <div class="log-entry">
                <span class="log-time">--:--:--</span>
                <span class="log-msg">系統初始化完成，等待啟動...</span>
            </div>
        </div>
    </div>

    <div id="loader-overlay">
        <h3 id="loader-text" style="color:white;">VIRTUAL FENCE SYSTEM</h3>
        <button id="btn-start">INITIALIZE SYSTEM</button>
    </div>

    <script>
        // --- 全域變數設定 ---
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const statusEl = document.getElementById('system-status');
        const logContainer = document.getElementById('log-container');
        
        let model = undefined;
        let isDetecting = false;
        
        // 定義虛擬圍籬區域 (以百分比定義，適應不同螢幕解析度)
        // x, y: 左上角起點 (0.1 = 10%), w, h: 寬高
        const RESTRICTED_ZONE = { x: 0.25, y: 0.25, w: 0.5, h: 0.5 }; 
        
        // 狀態管理
        let intrusionActive = false;
        let lastLogTime = 0;

        // --- 1. 系統啟動 ---
        document.getElementById('btn-start').addEventListener('click', async (e) => {
            e.target.innerText = "LOADING AI MODELS...";
            e.target.disabled = true;
            
            try {
                model = await cocoSsd.load(); // 載入模型
                await setupCamera();          // 啟動相機
                
                document.getElementById('loader-overlay').style.display = 'none';
                resizeCanvas();
                window.addEventListener('resize', resizeCanvas);
                
                addLog("System Started", "INFO");
                predictLoop(); // 開始循環
            } catch (err) {
                alert("Error: " + err.message);
                e.target.innerText = "RETRY";
                e.target.disabled = false;
            }
        });

        async function setupCamera() {
            const stream = await navigator.mediaDevices.getUserMedia({
                audio: false,
                video: { facingMode: 'environment', width: { ideal: 640 }, height: { ideal: 480 } }
            });
            video.srcObject = stream;
            return new Promise(r => video.onloadedmetadata = () => r());
        }

        function resizeCanvas() {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
        }

        // --- 2. 核心邏輯循環 ---
        async function predictLoop() {
            // 偵測物件
            const predictions = await model.detect(video, 20, 0.3); // 降低一點閾值以提高靈敏度
            
            // 清空畫布
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 1. 繪製並計算「虛擬圍籬」
            const zonePixel = drawRestrictedZone();
            
            // 2. 處理每一個偵測到的物件
            let currentIntrusion = false;

            predictions.forEach(prediction => {
                // 繪製物件框
                drawObject(prediction);

                // 邏輯判斷：只有「人」才觸發警報
                if (prediction.class === 'person') {
                    if (checkIntersection(prediction.bbox, zonePixel)) {
                        currentIntrusion = true;
                        drawHighlight(prediction.bbox); // 強調顯示
                    }
                }
            });

            // 3. 更新系統狀態與日誌
            updateSystemState(currentIntrusion);

            requestAnimationFrame(predictLoop);
        }

        // --- 3. 繪圖與計算函式 (Professional Logic) ---

        // 繪製半透明的紅色警戒區
        function drawRestrictedZone() {
            const zx = canvas.width * RESTRICTED_ZONE.x;
            const zy = canvas.height * RESTRICTED_ZONE.y;
            const zw = canvas.width * RESTRICTED_ZONE.w;
            const zh = canvas.height * RESTRICTED_ZONE.h;

            ctx.save();
            ctx.strokeStyle = "rgba(255, 0, 0, 0.8)";
            ctx.lineWidth = 3;
            // 畫虛線效果，看起來更像工程圖
            ctx.setLineDash([10, 5]); 
            ctx.strokeRect(zx, zy, zw, zh);
            
            // 填滿淡淡的紅色
            ctx.fillStyle = "rgba(255, 0, 0, 0.15)";
            ctx.fillRect(zx, zy, zw, zh);
            
            // 標示文字
            ctx.fillStyle = "#ff3333";
            ctx.font = "bold 14px Consolas";
            ctx.fillText("RESTRICTED AREA / 禁止進入", zx + 5, zy + 20);
            ctx.restore();

            return { x: zx, y: zy, w: zw, h: zh };
        }

        // 碰撞檢測 (AABB Collision Detection)
        // 判斷兩個矩形是否有重疊
        function checkIntersection(bbox, zone) {
            const [bx, by, bw, bh] = bbox;
            
            // 判斷不重疊的情況，取反即為重疊
            const notOverlap = (
                bx + bw < zone.x ||    // 物體在區域左邊
                bx > zone.x + zone.w || // 物體在區域右邊
                by + bh < zone.y ||    // 物體在區域上邊
                by > zone.y + zone.h    // 物體在區域下邊
            );

            return !notOverlap;
        }

        function drawObject(prediction) {
            const [x, y, width, height] = prediction.bbox;
            const isPerson = prediction.class === 'person';
            
            // 顏色區分：人是白色，其他是灰色
            const color = isPerson ? "#ffffff" : "#666666";
            
            ctx.strokeStyle = color;
            ctx.lineWidth = 2;
            ctx.strokeRect(x, y, width, height);

            ctx.fillStyle = color;
            ctx.font = "12px Consolas";
            const label = `${prediction.class} ${(prediction.score*100).toFixed(0)}%`;
            ctx.fillText(label, x, y - 5);
        }

        // 當入侵發生時，繪製強力警告框
        function drawHighlight(bbox) {
            const [x, y, width, height] = bbox;
            ctx.save();
            ctx.strokeStyle = "#ff0000";
            ctx.lineWidth = 5;
            ctx.strokeRect(x, y, width, height);
            ctx.restore();
        }

        // --- 4. 系統後端模擬 (Log Logic) ---
        function updateSystemState(isIntruderDetected) {
            const now = Date.now();

            if (isIntruderDetected) {
                // 狀態改變：正常 -> 入侵
                if (!intrusionActive) {
                    intrusionActive = true;
                    statusEl.innerText = "WARNING: INTRUSION";
                    statusEl.className = "status-alert";
                    document.body.style.borderColor = "red";
                    addLog("Detected Unauthorized Entry", "ALERT");
                }
            } else {
                // 狀態改變：入侵 -> 正常
                if (intrusionActive) {
                    intrusionActive = false;
                    statusEl.innerText = "NORMAL";
                    statusEl.className = "status-normal";
                    document.body.style.borderColor = "transparent";
                    addLog("Zone Clear", "INFO");
                }
            }
        }

        function addLog(message, type) {
            const timeStr = new Date().toLocaleTimeString('zh-TW', { hour12: false });
            
            const div = document.createElement('div');
            div.className = 'log-entry';
            
            const typeClass = type === 'ALERT' ? 'log-type-alert' : '';
            
            div.innerHTML = `
                <span class="log-time">[${timeStr}]</span>
                <span class="log-msg ${typeClass}">${message}</span>
            `;
            
            // 新日誌加在最上面
            logContainer.prepend(div);
            
            // 保持日誌長度不超過 50 筆，避免記憶體溢出
            if (logContainer.children.length > 50) {
                logContainer.removeChild(logContainer.lastChild);
            }
        }
    </script>
</body>
</html>
