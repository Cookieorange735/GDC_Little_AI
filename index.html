<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI 虛擬圍籬監控系統 (警報版)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.11.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.2/dist/coco-ssd.min.js"></script>

    <style>
        /* --- Cyberpunk UI Style --- */
        :root {
            --primary-color: #00ffcc;
            --danger-color: #ff3333;
            --bg-color: #0d1117;
            --panel-bg: rgba(13, 17, 23, 0.9);
        }

        body {
            margin: 0;
            background-color: var(--bg-color);
            font-family: "Consolas", "Monaco", "Courier New", monospace;
            color: white;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        #main-view {
            position: relative;
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #000;
            border-bottom: 2px solid #333;
        }

        video, canvas {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #dashboard {
            height: 35%;
            background: var(--panel-bg);
            padding: 10px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            border-top: 1px solid var(--primary-color);
            z-index: 10;
        }

        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
        }

        h2 { margin: 0; font-size: 16px; color: var(--primary-color); text-transform: uppercase; letter-spacing: 1px; }

        #system-status {
            font-weight: bold;
            padding: 2px 8px;
            border-radius: 4px;
            background: #333;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .status-normal { color: #00ffcc; border: 1px solid #00ffcc; }
        .status-alert { color: #fff; background: var(--danger-color) !important; animation: blink 0.5s infinite; }

        #log-container {
            flex: 1;
            overflow-y: auto;
            font-size: 12px;
            border: 1px solid #333;
            background: #000;
            padding: 5px;
        }

        .log-entry { display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #222; }
        .log-time { color: #888; margin-right: 10px; }
        .log-msg { color: #ddd; }
        .log-type-alert { color: var(--danger-color); font-weight: bold; }

        #loader-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 99;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }
        
        button {
            background: transparent; border: 1px solid var(--primary-color);
            color: var(--primary-color); padding: 15px 40px;
            font-family: inherit; cursor: pointer; font-size: 16px; margin-top: 20px;
            text-transform: uppercase; letter-spacing: 2px;
            transition: 0.2s;
        }
        button:hover { background: rgba(0, 255, 204, 0.2); box-shadow: 0 0 15px var(--primary-color); }

        @keyframes blink { 50% { opacity: 0.5; } }
    </style>
</head>
<body>

    <div id="main-view">
        <video id="video" playsinline muted autoplay></video>
        <canvas id="canvas"></canvas>
    </div>

    <div id="dashboard">
        <div class="header-row">
            <h2>SYSTEM LOG // 監控日誌</h2>
            <div id="system-status" class="status-normal">NORMAL</div>
        </div>
        <div id="log-container">
            <div class="log-entry">
                <span class="log-time">--:--:--</span>
                <span class="log-msg">系統待命...</span>
            </div>
        </div>
    </div>

    <div id="loader-overlay">
        <h3 id="loader-text" style="color:white; letter-spacing: 3px;">SECURE ZONE DEFENSE</h3>
        <p style="color: #666; font-size: 0.8em;">AUDIO SYSTEM REQUIRED</p>
        <button id="btn-start">INITIALIZE SYSTEM</button>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const statusEl = document.getElementById('system-status');
        const logContainer = document.getElementById('log-container');
        
        let model = undefined;
        // 定義警戒區 (畫面中間 50% 的區域)
        const RESTRICTED_ZONE = { x: 0.25, y: 0.25, w: 0.5, h: 0.5 }; 
        let intrusionActive = false;

        // --- Audio System (Web Audio API) ---
        let audioCtx = null;
        let oscillator = null;
        let gainNode = null;
        let sirenInterval = null;

        // 1. 初始化音效系統 (必須在使用者點擊後觸發)
        function initAudio() {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioCtx = new AudioContext();
        }

        // 2. 播放警報聲 (頻率波動的 Siren)
        function startSiren() {
            if (oscillator) return; // 已經在響了

            // 建立振盪器 (發聲源)
            oscillator = audioCtx.createOscillator();
            gainNode = audioCtx.createGain();
            
            oscillator.type = 'square'; // 方波，聲音比較刺耳，適合警報
            oscillator.frequency.value = 700; // 初始頻率

            // 連接節點: Source -> Gain -> Speaker
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            oscillator.start();

            // 製造高低音切換效果 (類似警車: 嗶-布-嗶-布)
            let isHigh = false;
            sirenInterval = setInterval(() => {
                if (oscillator) {
                    const freq = isHigh ? 600 : 900;
                    // 平滑過渡頻率
                    oscillator.frequency.rampToValueAtTime(freq, audioCtx.currentTime + 0.1);
                    isHigh = !isHigh;
                }
            }, 300); // 每 300ms 切換一次
        }

        // 3. 停止警報
        function stopSiren() {
            if (oscillator) {
                oscillator.stop();
                oscillator.disconnect();
                oscillator = null;
            }
            if (sirenInterval) {
                clearInterval(sirenInterval);
                sirenInterval = null;
            }
        }

        // --- Main Logic ---

        document.getElementById('btn-start').addEventListener('click', async (e) => {
            e.target.innerText = "LOADING...";
            e.target.disabled = true;
            
            try {
                initAudio(); // 啟動音效引擎
                model = await cocoSsd.load();
                await setupCamera();
                
                document.getElementById('loader-overlay').style.display = 'none';
                resizeCanvas();
                window.addEventListener('resize', resizeCanvas);
                
                addLog("System Initialized", "INFO");
                addLog("Audio Engine: READY", "INFO");
                predictLoop();
            } catch (err) {
                alert("Error: " + err.message);
                e.target.innerText = "RETRY";
                e.target.disabled = false;
            }
        });

        async function setupCamera() {
            const stream = await navigator.mediaDevices.getUserMedia({
                audio: false,
                video: { facingMode: 'environment', width: { ideal: 640 }, height: { ideal: 480 } }
            });
            video.srcObject = stream;
            return new Promise(r => video.onloadedmetadata = () => r());
        }

        function resizeCanvas() {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
        }

        async function predictLoop() {
            const predictions = await model.detect(video, 20, 0.3);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 繪製警戒區
            const zonePixel = drawRestrictedZone();
            
            let currentIntrusion = false;

            predictions.forEach(prediction => {
                drawObject(prediction);

                // 只有「人」且「進入警戒區」才觸發
                if (prediction.class === 'person') {
                    if (checkIntersection(prediction.bbox, zonePixel)) {
                        currentIntrusion = true;
                        drawHighlight(prediction.bbox);
                    }
                }
            });

            updateSystemState(currentIntrusion);
            requestAnimationFrame(predictLoop);
        }

        function drawRestrictedZone() {
            const zx = canvas.width * RESTRICTED_ZONE.x;
            const zy = canvas.height * RESTRICTED_ZONE.y;
            const zw = canvas.width * RESTRICTED_ZONE.w;
            const zh = canvas.height * RESTRICTED_ZONE.h;

            ctx.save();
            ctx.strokeStyle = intrusionActive ? "rgba(255, 0, 0, 1)" : "rgba(255, 0, 0, 0.6)";
            ctx.lineWidth = intrusionActive ? 5 : 2;
            ctx.setLineDash([10, 5]); 
            ctx.strokeRect(zx, zy, zw, zh);
            
            // 如果入侵中，背景變紅
            ctx.fillStyle = intrusionActive ? "rgba(255, 0, 0, 0.3)" : "rgba(255, 0, 0, 0.1)";
            ctx.fillRect(zx, zy, zw, zh);
            
            ctx.fillStyle = "#ff3333";
            ctx.font = "bold 14px Consolas";
            ctx.fillText("RESTRICTED AREA // 禁止進入", zx + 5, zy + 20);
            ctx.restore();

            return { x: zx, y: zy, w: zw, h: zh };
        }

        function checkIntersection(bbox, zone) {
            const [bx, by, bw, bh] = bbox;
            const notOverlap = (
                bx + bw < zone.x || bx > zone.x + zone.w ||
                by + bh < zone.y || by > zone.y + zone.h
            );
            return !notOverlap;
        }

        function drawObject(prediction) {
            const [x, y, width, height] = prediction.bbox;
            const isPerson = prediction.class === 'person';
            const color = isPerson ? "#ffffff" : "#666666";
            
            ctx.strokeStyle = color;
            ctx.lineWidth = 1;
            ctx.strokeRect(x, y, width, height);

            if(isPerson) {
                ctx.fillStyle = color;
                ctx.font = "12px Consolas";
                ctx.fillText(`${prediction.class} ${(prediction.score*100).toFixed(0)}%`, x, y - 5);
            }
        }

        function drawHighlight(bbox) {
            const [x, y, width, height] = bbox;
            ctx.save();
            ctx.strokeStyle = "#ff0000";
            ctx.lineWidth = 6;
            ctx.strokeRect(x, y, width, height);
            ctx.restore();
        }

        function updateSystemState(isIntruderDetected) {
            if (isIntruderDetected) {
                if (!intrusionActive) {
                    // --- 狀態切換：開始入侵 ---
                    intrusionActive = true;
                    statusEl.innerText = "WARNING: INTRUSION";
                    statusEl.className = "status-alert";
                    document.body.style.borderColor = "red";
                    addLog("⚠️ SECURITY BREACH DETECTED", "ALERT");
                    
                    // 啟動警報聲
                    startSiren();
                }
            } else {
                if (intrusionActive) {
                    // --- 狀態切換：入侵結束 ---
                    intrusionActive = false;
                    statusEl.innerText = "NORMAL";
                    statusEl.className = "status-normal";
                    document.body.style.borderColor = "transparent";
                    addLog("Zone Clear / Threat Removed", "INFO");
                    
                    // 停止警報聲
                    stopSiren();
                }
            }
        }

        function addLog(message, type) {
            const timeStr = new Date().toLocaleTimeString('zh-TW', { hour12: false });
            const div = document.createElement('div');
            div.className = 'log-entry';
            const typeClass = type === 'ALERT' ? 'log-type-alert' : '';
            div.innerHTML = `<span class="log-time">[${timeStr}]</span><span class="log-msg ${typeClass}">${message}</span>`;
            logContainer.prepend(div);
            if (logContainer.children.length > 50) logContainer.removeChild(logContainer.lastChild);
        }
    </script>
</body>
</html>
